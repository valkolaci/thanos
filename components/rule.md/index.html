<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css integrity=sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.7.1/css/all.css integrity=sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr crossorigin=anonymous><link rel=stylesheet href=https://improbable-eng.github.io/thanos/main.css><link rel=stylesheet href=https://improbable-eng.github.io/thanos/syntax.css><link rel=icon href=https://improbable-eng.github.io/thanos/icon-light.png><title>Thanos - Highly available Prometheus setup with long term storage capabilities</title><meta property=og:image content=/icon-light.png><meta property=og:type content=object><meta property=og:title content=Thanos><meta property=og:description content="Thanos - Highly available Prometheus setup with long term storage capabilities"></head><body><nav class="navbar navbar-expand-lg navbar-dark bg-purple"><a href=https://improbable-eng.github.io/thanos/ class=navbar-brand><img src=https://improbable-eng.github.io/thanos/icon-dark.png alt="Thanos logo"> Thanos</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://improbable-eng.github.io/thanos/getting-started.md>Documentation</a></li><li class=nav-item><a class=nav-link href=https://github.com/improbable-eng/thanos/releases>Download</a></li><li class=nav-item><a href=https://github.com/improbable-eng/thanos class=nav-link><i class="fab fa-fw fa-github"></i>GitHub</a></li><li class=nav-item><a href=https://twitter.com/ThanosMetrics class=nav-link><i class="fab fa-fw fa-twitter"></i>Twitter</a></li></ul></div></nav><div class=container><div class="row py-3 py-lg-5"><div class="col-12 col-lg-3"><button class="btn btn-block btn-outline-secondary mb-3 d-block d-lg-none" type=button data-toggle=collapse data-target=.docs-menu>
Toggle Menu</button><nav class="docs-menu collapse d-lg-block"><h5>Thanos</h5><div class="list-group list-group-flush"><a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/getting-started.md/>Getting Started</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/changelog/>Changelog</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/design.md/>Design</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/storage.md/>Object Storage</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/service-discovery.md/>Service Discovery</a></div><h5 class=mt-3>Components</h5><div class="list-group list-group-flush"><a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/components/bucket.md/>Bucket</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/components/compact.md/>Compact</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/components/query.md/>Query</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/components/rule.md/>Rule</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/components/sidecar.md/>Sidecar</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/components/store.md/>Store</a></div><h5 class=mt-3>Contributing</h5><div class="list-group list-group-flush"><a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/code_of_conduct/>Code of Conduct</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/contributing/how-to-contribute-to-docs.md/>Contribute to docs</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/contributing/>Contributing</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/contributing/dev.md/>Troubleshooting for dev workflow</a></div><h5 class=mt-3>Proposals</h5><div class="list-group list-group-flush"><a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/proposals/201809_gossip-removal.md/>Deprecated gossip clustering in favor of File SD</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/proposals/201807_store_instance_high_availability.md/>High-availability for store instances</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/proposals/201901-read-write-operations-bucket.md/>Read-Write coordination free operational contract for object storage</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/proposals/config.md/>Thanos Cluster Configuration</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://improbable-eng.github.io/thanos/proposals/201812_thanos-remote-receive.md/>Thanos Remote Write</a></div></nav></div><div class="col-12 col-lg-9"><h1 id=rule>Rule</h1><p><em><strong>NOTE:</strong> The rule component is experimental since it has conceptual tradeoffs that might not be favorable for most use cases. It is recommended to keep deploying rules to the relevant Prometheus servers.</em></p><p><em>The rule component should in particular not be used to circumvent solving rule deployment properly at the configuration management level.</em></p><p>The rule component evaluates Prometheus recording and alerting rules against random query nodes in its cluster. Rule results are written back to disk in the Prometheus 2.0 storage format. Rule nodes at the same time participate in the cluster themselves as source store nodes and upload their generated TSDB blocks to an object store.</p><p>The data of each rule node can be labeled to satisfy the clusters labeling scheme. High-availability pairs can be run in parallel and should be distinguished by the designated replica label, just like regular Prometheus servers.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ thanos rule <span class=se>\
</span><span class=se></span>    --data-dir          <span class=s2>&#34;/path/to/data&#34;</span> <span class=se>\
</span><span class=se></span>    --eval-interval     <span class=s2>&#34;30s&#34;</span> <span class=se>\
</span><span class=se></span>    --rule-file         <span class=s2>&#34;/path/to/rules/*.rules.yaml&#34;</span> <span class=se>\
</span><span class=se></span>    --alert.query-url   <span class=s2>&#34;http://0.0.0.0:9090&#34;</span> <span class=se>\
</span><span class=se></span>    --alertmanagers.url <span class=s2>&#34;alert.thanos.io&#34;</span> <span class=se>\
</span><span class=se></span>    --cluster.peers     <span class=s2>&#34;thanos-cluster.example.org&#34;</span> <span class=se>\
</span><span class=se></span>    --objstore.config-file <span class=s2>&#34;bucket.yml&#34;</span></code></pre></div><p>The content of <code>bucket.yml</code>:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml>type<span class=p>:</span><span class=w> </span>GCS<span class=w>
</span><span class=w></span>config<span class=p>:</span><span class=w>
</span><span class=w>  </span>bucket<span class=p>:</span><span class=w> </span>example-bucket</code></pre></div><p>As rule nodes outsource query processing to query nodes, they should generally experience little load. If necessary, functional sharding can be applied by splitting up the sets of rules between HA pairs.
Rules are processed with deduplicated data according to the replica label configured on query nodes.</p><h2 id=deployment>Deployment</h2><h2 id=flags>Flags</h2><div class=highlight><pre class=chroma><code class=language-$ data-lang=$>usage: thanos rule [&lt;flags&gt;]

ruler evaluating Prometheus rules against given Query nodes, exposing Store API
and storing old blocks in bucket

Flags:
  -h, --help                     Show context-sensitive help (also try
                                 --help-long and --help-man).
      --version                  Show application version.
      --log.level=info           Log filtering level.
      --log.format=logfmt        Log format to use.
      --gcloudtrace.project=GCLOUDTRACE.PROJECT
                                 GCP project to send Google Cloud Trace tracings
                                 to. If empty, tracing will be disabled.
      --gcloudtrace.sample-factor=1
                                 How often we send traces (1/&lt;sample-factor&gt;).
                                 If 0 no trace will be sent periodically, unless
                                 forced by baggage item. See
                                 `pkg/tracing/tracing.go` for details.
      --http-address=&#34;0.0.0.0:10902&#34;
                                 Listen host:port for HTTP endpoints.
      --grpc-address=&#34;0.0.0.0:10901&#34;
                                 Listen ip:port address for gRPC endpoints
                                 (StoreAPI). Make sure this address is routable
                                 from other components if you use gossip,
                                 &#39;grpc-advertise-address&#39; is empty and you
                                 require cross-node connection.
      --grpc-server-tls-cert=&#34;&#34;  TLS Certificate for gRPC server, leave blank to
                                 disable TLS
      --grpc-server-tls-key=&#34;&#34;   TLS Key for the gRPC server, leave blank to
                                 disable TLS
      --grpc-server-tls-client-ca=&#34;&#34;
                                 TLS CA to verify clients against. If no client
                                 CA is specified, there is no client
                                 verification on server side. (tls.NoClientCert)
      --grpc-advertise-address=GRPC-ADVERTISE-ADDRESS
                                 Explicit (external) host:port address to
                                 advertise for gRPC StoreAPI in gossip cluster.
                                 If empty, &#39;grpc-address&#39; will be used.
      --cluster.address=&#34;0.0.0.0:10900&#34;
                                 Listen ip:port address for gossip cluster.
      --cluster.advertise-address=CLUSTER.ADVERTISE-ADDRESS
                                 Explicit (external) ip:port address to
                                 advertise for gossip in gossip cluster. Used
                                 internally for membership only.
      --cluster.peers=CLUSTER.PEERS ...
                                 Initial peers to join the cluster. It can be
                                 either &lt;ip:port&gt;, or &lt;domain:port&gt;. A lookup
                                 resolution is done only at the startup.
      --cluster.gossip-interval=&lt;gossip interval&gt;
                                 Interval between sending gossip messages. By
                                 lowering this value (more frequent) gossip
                                 messages are propagated across the cluster more
                                 quickly at the expense of increased bandwidth.
                                 Default is used from a specified network-type.
      --cluster.pushpull-interval=&lt;push-pull interval&gt;
                                 Interval for gossip state syncs. Setting this
                                 interval lower (more frequent) will increase
                                 convergence speeds across larger clusters at
                                 the expense of increased bandwidth usage.
                                 Default is used from a specified network-type.
      --cluster.refresh-interval=1m
                                 Interval for membership to refresh
                                 cluster.peers state, 0 disables refresh.
      --cluster.secret-key=CLUSTER.SECRET-KEY
                                 Initial secret key to encrypt cluster gossip.
                                 Can be one of AES-128, AES-192, or AES-256 in
                                 hexadecimal format.
      --cluster.network-type=lan
                                 Network type with predefined peers
                                 configurations. Sets of configurations
                                 accounting the latency differences between
                                 network types: local, lan, wan.
      --cluster.disable          If true gossip will be disabled and no cluster
                                 related server will be started.
      --label=&lt;name&gt;=&#34;&lt;value&gt;&#34; ...
                                 Labels to be applied to all generated metrics
                                 (repeated). Similar to external labels for
                                 Prometheus, used to identify ruler and its
                                 blocks as unique source.
      --data-dir=&#34;data/&#34;         data directory
      --rule-file=rules/ ...     Rule files that should be used by rule manager.
                                 Can be in glob format (repeated).
      --eval-interval=30s        The default evaluation interval to use.
      --tsdb.block-duration=2h   Block duration for TSDB block.
      --tsdb.retention=48h       Block retention time on local disk.
      --alertmanagers.url=ALERTMANAGERS.URL ...
                                 Alertmanager replica URLs to push firing
                                 alerts. Ruler claims success if push to at
                                 least one alertmanager from discovered
                                 succeeds. The scheme may be prefixed with
                                 &#39;dns+&#39; or &#39;dnssrv+&#39; to detect Alertmanager IPs
                                 through respective DNS lookups. The port
                                 defaults to 9093 or the SRV record&#39;s value. The
                                 URL path is used as a prefix for the regular
                                 Alertmanager API path.
      --alertmanagers.send-timeout=10s
                                 Timeout for sending alerts to alertmanager
      --alert.query-url=ALERT.QUERY-URL
                                 The external Thanos Query URL that would be set
                                 in all alerts &#39;Source&#39; field
      --alert.label-drop=ALERT.LABEL-DROP ...
                                 Labels by name to drop before sending to
                                 alertmanager. This allows alert to be
                                 deduplicated on replica label (repeated).
                                 Similar Prometheus alert relabelling
      --web.route-prefix=&#34;&#34;      Prefix for API and UI endpoints. This allows
                                 thanos UI to be served on a sub-path. This
                                 option is analogous to --web.route-prefix of
                                 Promethus.
      --web.external-prefix=&#34;&#34;   Static prefix for all HTML links and redirect
                                 URLs in the UI query web interface. Actual
                                 endpoints are still served on / or the
                                 web.route-prefix. This allows thanos UI to be
                                 served behind a reverse proxy that strips a URL
                                 sub-path.
      --web.prefix-header=&#34;&#34;     Name of HTTP request header used for dynamic
                                 prefixing of UI links and redirects. This
                                 option is ignored if web.external-prefix
                                 argument is set. Security risk: enable this
                                 option only if a reverse proxy in front of
                                 thanos is resetting the header. The
                                 --web.prefix-header=X-Forwarded-Prefix option
                                 can be useful, for example, if Thanos UI is
                                 served via Traefik reverse proxy with
                                 PathPrefixStrip option enabled, which sends the
                                 stripped prefix value in X-Forwarded-Prefix
                                 header. This allows thanos UI to be served on a
                                 sub-path.
      --objstore.config-file=&lt;bucket.config-yaml-path&gt;
                                 Path to YAML file that contains object store
                                 configuration.
      --objstore.config=&lt;bucket.config-yaml&gt;
                                 Alternative to &#39;objstore.config-file&#39; flag.
                                 Object store configuration in YAML.
      --query=&lt;query&gt; ...        Addresses of statically configured query API
                                 servers (repeatable). The scheme may be
                                 prefixed with &#39;dns+&#39; or &#39;dnssrv+&#39; to detect
                                 query API servers through respective DNS
                                 lookups.
      --query.sd-files=&lt;path&gt; ...
                                 Path to file that contain addresses of query
                                 peers. The path can be a glob pattern
                                 (repeatable).
      --query.sd-interval=5m     Refresh interval to re-read file SD files.
                                 (used as a fallback)
      --query.sd-dns-interval=30s
                                 Interval between DNS resolutions.</code></pre></div></div></div></div><footer class="bg-dark text-light"><div class="container text-center text-md-left"><div class="row py-5"><div class="col-12 col-md-6 col-lg mb-3 mb-lg-0"><img src=https://improbable-eng.github.io/thanos/icon-dark.png alt=Thanos width=45%></div><div class="col-12 col-md-6 col-lg"><h6 class=font-weight-bold>Documentation</h6><ul class=list-unstyled><li><a class=text-reset href=https://improbable-eng.github.io/thanos/getting-started.md>Getting Started</a></li><li><a class=text-reset href=https://improbable-eng.github.io/thanos/design.md>Design</a></li><li><a class=text-reset href=https://improbable-eng.github.io/thanos/storage.md>Storage</a></li><li><a class=text-reset href=https://improbable-eng.github.io/thanos/service-discovery.md>Service Discovery</a></li></ul></div><div class="col-12 col-md-6 col-lg"><h6 class=font-weight-bold>Community</h6><ul class=list-unstyled><li><a href=https://join.slack.com/t/improbable-eng/shared_invite/enQtMzQ1ODcyMzQ5MjM4LWY5ZWZmNGM2ODc5MmViNmQ3ZTA3ZTY3NzQwOTBlMTkzZmIxZTIxODk0OWU3YjZhNWVlNDU3MDlkZGViZjhkMjc class=text-reset><i class="fab fa-fw fa-slack"></i>Slack</a></li><li><a href=https://github.com/improbable-eng/thanos class=text-reset><i class="fab fa-fw fa-github"></i>GitHub</a></li><li><a href=https://twitter.com/ThanosMetrics class=text-reset><i class="fab fa-fw fa-twitter"></i>Twitter</a></li></ul></div><div class="col col-md-6 col-lg"><h6 class=font-weight-bold>About</h6><p>Thanos is an OSS licensed project as Apache License 2.0</p></div></div></div></footer><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js integrity=sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js integrity=sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k crossorigin=anonymous></script></body></html>