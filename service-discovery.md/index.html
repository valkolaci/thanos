<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css integrity=sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.7.1/css/all.css integrity=sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr crossorigin=anonymous><link rel=stylesheet href=https://adrien-f.github.io/thanos/main.css><link rel=stylesheet href=https://adrien-f.github.io/thanos/syntax.css><link rel=icon href=https://adrien-f.github.io/thanos/icon-light.png><title>Thanos - Highly available Prometheus setup with long term storage capabilities</title><meta property=og:image content=/icon-light.png><meta property=og:type content=object><meta property=og:title content=Thanos><meta property=og:description content="Thanos - Highly available Prometheus setup with long term storage capabilities"></head><body><nav class="navbar navbar-expand-lg navbar-dark bg-purple"><a href=https://adrien-f.github.io/thanos/ class=navbar-brand><img src=https://adrien-f.github.io/thanos/icon-dark.png alt="Thanos logo"> Thanos</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://adrien-f.github.io/thanos/getting-started.md>Documentation</a></li><li class=nav-item><a class=nav-link href=https://github.com/improbable-eng/thanos/releases>Download</a></li><li class=nav-item><a href=https://github.com/improbable-eng/thanos class=nav-link><i class="fab fa-fw fa-github"></i>GitHub</a></li><li class=nav-item><a href=https://twitter.com/ThanosMetrics class=nav-link><i class="fab fa-fw fa-twitter"></i>Twitter</a></li></ul></div></nav><div class=container><div class="row py-3 py-lg-5"><div class="col-12 col-lg-3"><button class="btn btn-block btn-outline-secondary mb-3 d-block d-lg-none" type=button data-toggle=collapse data-target=.docs-menu>
Toggle Menu</button><nav class="docs-menu collapse d-lg-block"><h5>Thanos</h5><div class="list-group list-group-flush"><a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://adrien-f.github.io/thanos/getting-started.md/>Getting Started</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://adrien-f.github.io/thanos/changelog/>Changelog</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://adrien-f.github.io/thanos/design.md/>Design</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://adrien-f.github.io/thanos/storage.md/>Object Storage</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://adrien-f.github.io/thanos/service-discovery.md/>Service Discovery</a></div><h5 class=mt-3>Components</h5><div class="list-group list-group-flush"><a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://adrien-f.github.io/thanos/components/bucket.md/>Bucket</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://adrien-f.github.io/thanos/components/compact.md/>Compact</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://adrien-f.github.io/thanos/components/query.md/>Query</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://adrien-f.github.io/thanos/components/rule.md/>Rule</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://adrien-f.github.io/thanos/components/sidecar.md/>Sidecar</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://adrien-f.github.io/thanos/components/store.md/>Store</a></div><h5 class=mt-3>Contributing</h5><div class="list-group list-group-flush"><a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://adrien-f.github.io/thanos/code_of_conduct/>Code of Conduct</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://adrien-f.github.io/thanos/contributing/how-to-contribute-to-docs.md/>Contribute to docs</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://adrien-f.github.io/thanos/contributing/>Contributing</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://adrien-f.github.io/thanos/contributing/dev.md/>Troubleshooting for dev workflow</a></div><h5 class=mt-3>Proposals</h5><div class="list-group list-group-flush"><a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://adrien-f.github.io/thanos/proposals/201809_gossip-removal.md/>Deprecated gossip clustering in favor of File SD</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://adrien-f.github.io/thanos/proposals/201807_store_instance_high_availability.md/>High-availability for store instances</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://adrien-f.github.io/thanos/proposals/201901-read-write-operations-bucket.md/>Read-Write coordination free operational contract for object storage</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://adrien-f.github.io/thanos/proposals/config.md/>Thanos Cluster Configuration</a>
<a class="list-group-item list-group-item-action list-group-item-thanos py-1" href=https://adrien-f.github.io/thanos/proposals/201812_thanos-remote-receive.md/>Thanos Remote Write</a></div></nav></div><div class="col-12 col-lg-9"><h1 id=service-discovery>Service Discovery</h1><p>Service discovery has a vital place in Thanos components. It allows Thanos to discover different set API targets required to perform certain operations.
This logic is meant to replace Gossip that <a href=https://github.com/improbable-eng/thanos/tree/e47eba19ded12533f62c80242345b593a2aa2299/docs/docs/proposals/approved/201809_gossip-removal.md>is planned to be removed.</a></p><p>Currently places that uses Thanos SD:
* <code>Thanos Query</code> needs to know about <a href=https://github.com/improbable-eng/thanos/blob/d3fb337da94d11c78151504b1fccb1d7e036f394/pkg/store/storepb/rpc.proto#L14>StoreAPI</a> servers in order to query metrics from them.
* <code>Thanos Rule</code> needs to know about <code>QueryAPI</code> servers in order to evaluate recording and alerting rules.
* (Only static option with DNS discovery): <code>Thanos Rule</code> needs to know about <code>Alertmanagers</code> HA replicas in order to send alerts.</p><p>Currently there are several ways to configure this and they are described below in details:</p><ul><li>Static Flags</li><li>File SD</li><li>DNS SD</li></ul><h2 id=static-flags>Static Flags</h2><p>The simplest way to tell a component about a peer is to use a static flag.</p><h3 id=thanos-query>Thanos Query</h3><p>The repeatable flag <code>--store=&lt;store&gt;</code> can be used to specify a <code>StoreAPI</code> that <code>Thanos Query</code> should use.</p><h3 id=thanos-rule>Thanos Rule</h3><p>The repeatable flag <code>--query=&lt;query&gt;</code> can be used to specify a <code>QueryAPI</code> that <code>Thanos Rule</code> should use.</p><p>The repeatable flag <code>--alertmanager.url=&lt;alertmanager&gt;</code> can be used to specify a <code>Alertmanager API</code> that <code>Thanos Rule</code> should use.</p><h2 id=file-service-discovery>File Service Discovery</h2><p>File Service Discovery is another mechanism for configuring components. With File SD, a
list of files can be watched for updates, and the new configuration will be dynamically loaded when a change occurs.
The list of files to watch is passed to a component via a flag shown in the component specific sections below.</p><p>The format of the configuration file is the same as the one used in <a href=https://prometheus.io/docs/prometheus/latest/configuration/configuration/#file_sd_config>Prometheus&rsquo; File SD</a>.
Both YAML and JSON files can be used. The format of the files is this:</p><ul><li><p>JSON:</p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=p>[</span>
<span class=p>{</span>
<span class=nt>&#34;targets&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;localhost:9090&#34;</span><span class=p>,</span> <span class=s2>&#34;example.org:443&#34;</span><span class=p>]</span>
<span class=p>}</span>
<span class=p>]</span></code></pre></div></li><li><p>YAML:
```yaml</p></li><li><p>targets: [&lsquo;localhost:9090&rsquo;, &lsquo;example.org:443&rsquo;]
```</p></li></ul><p>As a fallback, the file contents are periodically re-read at an interval that can be set using a flag specific for the component and shown below.
The default value for all File SD re-read intervals is 5 minutes.</p><h3 id=thanos-query-1>Thanos Query</h3><p>The repeatable flag <code>--store.sd-files=&lt;path&gt;</code> can be used to specify the path to files that contain addresses of <code>StoreAPI</code> servers.
The <code>&lt;path&gt;</code> can be a glob pattern so you can specify several files using a single flag.</p><p>The flag <code>--store.sd-interval=&lt;5m&gt;</code> can be used to change the fallback re-read interval from the default 5 minutes.</p><h3 id=thanos-rule-1>Thanos Rule</h3><p>The repeatable flag <code>--query.sd-files=&lt;path&gt;</code> can be used to specify the path to files that contain addresses of <code>QueryAPI</code> servers.
Again, the <code>&lt;path&gt;</code> can be a glob pattern.</p><p>The flag <code>--query.sd-interval=&lt;5m&gt;</code> can be used to change the fallback re-read interval.</p><h2 id=dns-service-discovery>DNS Service Discovery</h2><p>DNS Service Discovery is another mechanism for finding components that can be used in conjunction with Static Flags or File SD.
With DNS SD, a domain name can be specified and it will be periodically queried to discover a list of IPs.</p><p>To use DNS SD, just add one of the following prefixes to the domain name in your configuration:</p><ul><li><p><code>dns+</code> - the domain name after this prefix will be looked up as an A/AAAA query. <em>A port is required for this query type</em>.
An example using this lookup with a static flag:</p><pre><code>--store=dns+stores.thanos.mycompany.org:9090
</code></pre></li><li><p><code>dnssrv+</code> - the domain name after this prefix will be looked up as a SRV query. You do not need to specify a port as the
one from the query results will be used. An example:</p><pre><code>--store=dnssrv+_thanosstores._tcp.mycompany.org
</code></pre></li></ul><p>The default interval between DNS lookups is 30s. You can change it using the <code>store.sd-dns-interval</code> flag for <code>StoreAPI</code>
configuration in <code>Thanos Query</code>, or <code>query.sd-dns-interval</code> for <code>QueryAPI</code> configuration in <code>Thanos Rule</code>.</p><h2 id=other>Other</h2><p>Currently, there are no plans of adding other Service Discovery mechanisms like Consul SD, kube SD, etc. However, we welcome
people implementing their preferred Service Discovery by writing the results to File SD which will propagate them to the different Thanos components.</p></div></div></div><footer class="bg-dark text-light"><div class="container text-center text-md-left"><div class="row py-5"><div class="col-12 col-md-6 col-lg mb-3 mb-lg-0"><img src=https://adrien-f.github.io/thanos/icon-dark.png alt=Thanos width=45%></div><div class="col-12 col-md-6 col-lg"><h6 class=font-weight-bold>Documentation</h6><ul class=list-unstyled><li><a class=text-reset href=https://adrien-f.github.io/thanos/getting-started.md>Getting Started</a></li><li><a class=text-reset href=https://adrien-f.github.io/thanos/design.md>Design</a></li><li><a class=text-reset href=https://adrien-f.github.io/thanos/storage.md>Storage</a></li><li><a class=text-reset href=https://adrien-f.github.io/thanos/service-discovery.md>Service Discovery</a></li></ul></div><div class="col-12 col-md-6 col-lg"><h6 class=font-weight-bold>Community</h6><ul class=list-unstyled><li><a href=https://join.slack.com/t/improbable-eng/shared_invite/enQtMzQ1ODcyMzQ5MjM4LWY5ZWZmNGM2ODc5MmViNmQ3ZTA3ZTY3NzQwOTBlMTkzZmIxZTIxODk0OWU3YjZhNWVlNDU3MDlkZGViZjhkMjc class=text-reset><i class="fab fa-fw fa-slack"></i>Slack</a></li><li><a href=https://github.com/improbable-eng/thanos class=text-reset><i class="fab fa-fw fa-github"></i>GitHub</a></li><li><a href=https://twitter.com/ThanosMetrics class=text-reset><i class="fab fa-fw fa-twitter"></i>Twitter</a></li></ul></div><div class="col col-md-6 col-lg"><h6 class=font-weight-bold>About</h6><p>Thanos is an OSS licensed project as Apache License 2.0</p></div></div></div></footer><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js integrity=sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js integrity=sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k crossorigin=anonymous></script></body></html>